<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìˆ˜ì—… ì‹œê°„í‘œ êµê³¼ëª© ê³µë™ ì…ë ¥ ì‹œìŠ¤í…œ (10/27 ~ 11/14)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; }
    .grid-cell { padding:4px; border:1px solid #e5e7eb; text-align:center; font-size:.85rem; }
    .header-cell { background:#1f2937; color:#fff; font-weight:600; padding:10px 4px; }
    .subject-input { padding:4px 8px; border:1px solid #d1d5db; border-radius:.375rem; font-size:.75rem; width:100%; transition:.2s; }
    .subject-input:focus { outline:0; border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.5); }
    .header-cell.sticky-top { position:sticky; top:0; z-index:15; }
    .header-cell.sticky-col-1 { left:0; z-index:20; }
    .header-cell.sticky-col-2 { left:80px; z-index:20; }
    .grid-cell.sticky-col-1 { position:sticky; left:0; z-index:5; background:#f3f4f6; border-right:1px solid #e5e7eb; }
    .grid-cell.sticky-col-2 { position:sticky; left:80px; z-index:5; background:#f3f4f6; border-right:1px solid #e5e7eb; }
    @media (max-width: 768px){ .grade-input-group{display:flex;flex-direction:column;gap:4px} .subject-input{font-size:.8rem} }
    /* ì—ëŸ¬ ì˜¤ë²„ë ˆì´ */
    #fatal { display:none; position:fixed; left:0; right:0; top:0; padding:10px 14px; background:#fee2e2; color:#991b1b; border-bottom:1px solid #fecaca; z-index:10000; font-size:.9rem; white-space:pre-wrap; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-8">
  <!-- Fatal error overlay -->
  <div id="fatal"></div>

  <!-- Notification Toast -->
  <div id="notification" class="fixed top-5 right-5 text-white px-4 py-2 rounded-lg shadow" style="opacity:0;transition:.3s"></div>

  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
    <header class="mb-8 border-b pb-4 flex justify-between items-center flex-wrap gap-4">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸ—“ï¸ ìˆ˜ì—… ì‹œê°„í‘œ êµê³¼ëª© ê³µë™ ì…ë ¥ ì‹œìŠ¤í…œ</h1>
        <p class="text-gray-600 text-sm">
          <strong>ê¸°ê°„:</strong> 2025ë…„ 10ì›” 27ì¼ (ì›”) ~ 11ì›” 14ì¼ (ê¸ˆ) (ì´ 15ì¼) |
          <strong>ì‹œê°„:</strong> 1~6êµì‹œ, 40ë¶„ ìˆ˜ì—…
        </p>
      </div>
      <button onclick="exportScheduleToMarkdown()"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 shrink-0">
        ğŸ’¾ ìŠ¤ì¼€ì¤„ ë‚´ë³´ë‚´ê¸° (ë§ˆí¬ë‹¤ìš´)
      </button>
    </header>

    <div class="mt-4 mb-8 text-sm p-4 border rounded-lg bg-gray-50">
      <p class="font-medium">
        í™˜ê²½ ëª¨ë“œ: <span id="env-mode" class="font-mono text-gray-700 bg-gray-200 p-1 rounded-md text-xs">í™•ì¸ ì¤‘...</span>
        | ì‚¬ìš©ì ID (ê³µë™ ì‘ì—…ì í™•ì¸ìš©): <span id="user-id" class="font-mono text-blue-600 bg-blue-100 p-1 rounded-md text-xs">ë¡œë”© ì¤‘...</span>
      </p>
      <p>ì¸ì¦ ìƒíƒœ: <span id="auth-status" class="text-red-500 font-semibold">ì´ˆê¸°í™” ì¤‘...</span></p>
      <div id="error-message" class="hidden text-center py-2 text-red-600 font-semibold mt-2 border-t border-red-300"></div>
    </div>

    <div id="loading-message" class="text-center py-12 text-lg text-gray-500">
      ì‹¤ì‹œê°„ ì‹œê°„í‘œ ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
    </div>

    <div id="schedule-container" class="schedule-grid grid border border-gray-200 rounded-lg overflow-x-auto"></div>

    <footer class="mt-8 pt-4 border-t text-sm text-gray-500 text-center">
      <p>ëª¨ë“  ë³€ê²½ ì‚¬í•­ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥ ë° ê³µìœ ë©ë‹ˆë‹¤. êµê³¼ëª© ì…ë ¥ í›„ ì—”í„°(Enter)ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ë‹¤ë¥¸ ì¹¸ì„ ì„ íƒí•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤.</p>
    </footer>
  </div>

  <!-- ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸: body ëì—ì„œ ë¡œë“œ (ì´ˆê¸° í™”ë©´ì€ ë¬´ì¡°ê±´ ë¨¼ì € ë³´ì´ê²Œ) -->
  <script>
    // ì—ëŸ¬ ì˜¤ë²„ë ˆì´: ì–´ë–¤ ëŸ°íƒ€ì„ ì—ëŸ¬ë„ í™”ë©´ì— ë„ì›€
    window.addEventListener('error', (e) => {
      const el = document.getElementById('fatal');
      el.style.display = 'block';
      el.textContent = 'ì˜¤ë¥˜: ' + (e.error?.message || e.message);
    });
    window.addEventListener('unhandledrejection', (e) => {
      const el = document.getElementById('fatal');
      el.style.display = 'block';
      el.textContent = 'ì˜¤ë¥˜(ë¹„ë™ê¸°): ' + (e.reason?.message || String(e.reason));
    });
    // í† ìŠ¤íŠ¸
    window.showNotification = function(msg, ok){
      const n = document.getElementById('notification');
      n.textContent = msg;
      n.style.backgroundColor = ok ? '#10b981' : '#ef4444';
      n.style.opacity = '1';
      setTimeout(()=> n.style.opacity='0', 3000);
    };
    // ìœ í‹¸
    window.getDayName = (ds) => ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(ds).getDay()];
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ====== ìƒíƒœ ======
    let app, db, auth;
    let userId = 'loading';
    let currentScheduleData = {};

    // ====== ì„¤ì • ======
    const EXTERNAL_FIREBASE_CONFIG = {
      apiKey: "AIzaSyDyiPpRmnm1hZWsHAlD860AuhGcdJKEfC4",
      authDomain: "galwon.firebaseapp.com",
      projectId: "galwon",
      storageBucket: "galwon.firebasestorage.app",
      messagingSenderId: "165546187721",
      appId: "1:165546187721:web:4ea575eaf31523096f2618",
      measurementId: "G-PXSRPV7ZWM"
    };

    const isCanvasEnvironment = typeof window.__firebase_config !== 'undefined';
    const firebaseConfig = isCanvasEnvironment ? JSON.parse(window.__firebase_config || '{}') : EXTERNAL_FIREBASE_CONFIG;
    const appId = isCanvasEnvironment ? (window.__app_id || firebaseConfig.projectId || 'default-app-id-canvas') : (firebaseConfig.projectId || 'default-app-id-external');
    const SCHEDULE_DOC_PATH = `artifacts/${appId}/public/data/class_schedule/schedule_data`;

    const GRADE_LIST = ['2í•™ë…„','3í•™ë…„','4í•™ë…„','5í•™ë…„','6í•™ë…„'];
    const PERIOD_TIMES = { '1':'09:00~09:40','2':'09:50~10:30','3':'10:40~11:20','4':'11:30~12:10','5':'01:00~01:40','6':'01:40~02:20' };

    function generateDates(){
      const dates=[]; let d=new Date('2025-10-27T00:00:00'); const end=new Date('2025-11-14T00:00:00');
      while(d<=end){ const w=d.getDay(); if(w>=1&&w<=5){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); dates.push(`${y}-${m}-${day}`); } d.setDate(d.getDate()+1); }
      return dates;
    }
    const ALL_DATES = generateDates();

    function buildInitialData(){
      const init={};
      ALL_DATES.forEach(date=>{
        init[date]={};
        for(let p=1;p<=6;p++){
          const row={}; GRADE_LIST.forEach(g=>row[g]=''); init[date][p]=row;
        }
      });
      return init;
    }

    // ====== ë Œë” ======
    function renderSchedule(scheduleData){
      const container = document.getElementById('schedule-container');
      container.innerHTML='';
      container.style.display='grid';
      container.style.gridTemplateColumns=`80px 80px repeat(${ALL_DATES.length}, minmax(200px, 1fr))`;

      let header = `<div class="header-cell sticky-top sticky-col-1">êµì‹œ</div>`;
      header += `<div class="header-cell sticky-top sticky-col-2">ì‹œê°„</div>`;
      ALL_DATES.forEach(date=>{
        header += `<div class="header-cell sticky-top">${date.slice(5).replace('-','/')} (${window.getDayName(date)})</div>`;
      });
      container.insertAdjacentHTML('beforeend', header);

      for(let period=1; period<=6; period++){
        container.insertAdjacentHTML('beforeend', `<div class="grid-cell sticky-col-1 bg-gray-200 font-semibold">${period}êµì‹œ</div>`);
        container.insertAdjacentHTML('beforeend', `<div class="grid-cell sticky-col-2 bg-gray-200 text-xs text-gray-600">${PERIOD_TIMES[period]}</div>`);
        ALL_DATES.forEach(date=>{
          const periodData = scheduleData[date]?.[period] || {};
          container.insertAdjacentHTML('beforeend', `<div class="grid-cell text-left">${createInputElements(date, period, periodData)}</div>`);
        });
        if(period===4){
          container.insertAdjacentHTML('beforeend', `
            <div class="grid-cell sticky-col-1 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">ì ì‹¬</div>
            <div class="grid-cell sticky-col-2 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">ì‹œê°„</div>`);
          ALL_DATES.forEach(()=> container.insertAdjacentHTML('beforeend', `<div class="grid-cell bg-yellow-100 text-yellow-800 font-bold text-xs py-3 border-b-2 border-yellow-400">12:10~1:00</div>`));
        }
      }
    }

    function createInputElements(date, period, periodData){
      let html='';
      GRADE_LIST.forEach(grade=>{
        const subject = periodData[grade] || '';
        html += `
          <div class="flex items-center space-x-1 mb-1 last:mb-0">
            <label class="text-xs font-semibold text-gray-700 w-10 shrink-0">${grade}:</label>
            <input type="text" value="${subject}" placeholder="êµê³¼ëª©"
              title="${date.slice(5).replace('-', '/')} ${period}êµì‹œ ${grade} ìˆ˜ì—…"
              data-date="${date}" data-period="${period}" data-grade="${grade}"
              class="subject-input" onchange="handleInputChange(this)">
          </div>`;
      });
      return `<div class="grade-input-group">${html}</div>`;
    }

    // ====== ì´ë²¤íŠ¸ ======
    window.handleInputChange = async (el)=>{
      const date = el.getAttribute('data-date');
      const period = el.getAttribute('data-period');
      const grade = el.getAttribute('data-grade');
      const value = el.value;
      if(!db){ window.showNotification("DBê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", false); return; }
      const ref = doc(db, SCHEDULE_DOC_PATH);
      try{
        // ë¬¸ìì—´ ê²½ë¡œ ì‚¬ìš© (í•œê¸€ í‚¤ OK, ì (.)ë§Œ ì—†ìœ¼ë©´ ì•ˆì „)
        const path = `${date}.${period}.${grade}`;
        await updateDoc(ref, { [path]: value });
      }catch(e){
        console.error(e);
        window.showNotification(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${e.message}`, false);
      }
    };

    window.exportScheduleToMarkdown = ()=>{
      if(!Object.keys(currentScheduleData).length){ window.showNotification("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", false); return; }
      let md = `## ğŸ—“ï¸ ìµœì¢… í™•ì • ìˆ˜ì—… ì‹œê°„í‘œ (2025ë…„ 10ì›” 27ì¼ ~ 11ì›” 14ì¼)\n\n`;
      md += `| êµì‹œ/ì‹œê°„ | ${ALL_DATES.map(d => d.slice(5).replace('-', '/') + ' (' + window.getDayName(d) + ')').join(' | ')} |\n`;
      md += `| :---: | ${ALL_DATES.map(()=> '---').join('|')} |\n`;
      ['1','2','3','4','5','6'].forEach(p=>{
        let row = `| ${p}êµì‹œ (${PERIOD_TIMES[p]}) |`;
        ALL_DATES.forEach(date=>{
          const pd = currentScheduleData[date]?.[p] || {};
          let cell = '';
          GRADE_LIST.forEach(g=>{
            const s = pd[g] || '-';
            cell += `**${g.replace('í•™ë…„','í•™')}**: ${s} / `;
          });
          cell = cell.trim().slice(0,-1);
          row += ` ${cell} |`;
        });
        md += row + '\n';
        if(p==='4'){ md += `| **ì ì‹¬ì‹œê°„** | ${ALL_DATES.map(()=> '**ì ì‹¬ (12:10~1:00)**').join(' | ')} |\n`; }
      });
      const ta=document.createElement('textarea'); ta.value=md; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      window.showNotification("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!", true);
    };

    // ====== ì´ˆê¸°í™” ======
    async function init(){
      document.getElementById('env-mode').textContent = isCanvasEnvironment ? 'Canvas í™˜ê²½' : 'ì™¸ë¶€ ë¸Œë¼ìš°ì €';
      try{
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        if(isCanvasEnvironment && typeof window.__initial_auth_token !== 'undefined'){
          await signInWithCustomToken(auth, window.__initial_auth_token);
        }else{
          await signInAnonymously(auth);
        }
        onAuthStateChanged(auth, (user)=>{
          if(user){
            userId = user.uid;
            document.getElementById('user-id').textContent = userId;
            const s = document.getElementById('auth-status');
            s.textContent='ì¸ì¦ ì™„ë£Œ'; s.classList.remove('text-red-500'); s.classList.add('text-green-500');
            startScheduleListener();
          }else{
            document.getElementById('auth-status').textContent='ì¸ì¦ ì‹¤íŒ¨';
          }
        });
      }catch(e){
        const el=document.getElementById('fatal'); el.style.display='block'; el.textContent='ì´ˆê¸°í™” ì˜¤ë¥˜: ' + e.message;
        document.getElementById('loading-message').classList.add('hidden');
      }
    }

    function startScheduleListener(){
      const ref = doc(db, SCHEDULE_DOC_PATH);
      (async ()=>{
        try{
          const snap = await getDoc(ref);
          if(!snap.exists()){
            const initial = buildInitialData();
            try{ await setDoc(ref, initial); }
            catch(e){
              console.warn('ì´ˆê¸° ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨:', e);
              currentScheduleData = initial;
              renderSchedule(currentScheduleData);
              document.getElementById('loading-message').classList.add('hidden');
              window.showNotification('ì´ˆê¸° ë¬¸ì„œë¥¼ ë§Œë“¤ ê¶Œí•œì´ ì—†ì–´ ì„ì‹œ í‘œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. Firestore ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.', false);
            }
          }
          onSnapshot(ref, (s)=>{
            if(s.exists()){
              currentScheduleData = s.data();
              renderSchedule(currentScheduleData);
              document.getElementById('loading-message').classList.add('hidden');
            }else{
              if(!Object.keys(currentScheduleData).length){
                currentScheduleData = buildInitialData();
                renderSchedule(currentScheduleData);
                document.getElementById('loading-message').classList.add('hidden');
                window.showNotification('ë¬¸ì„œê°€ ì—†ì–´ ì„ì‹œ í‘œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.', false);
              }
            }
          }, (err)=>{
            const el=document.getElementById('fatal'); el.style.display='block'; el.textContent='ì‹¤ì‹œê°„ ì˜¤ë¥˜: ' + err.message;
            document.getElementById('loading-message').classList.add('hidden');
          });
        }catch(e){
          const el=document.getElementById('fatal'); el.style.display='block'; el.textContent='ë¬¸ì„œ í™•ì¸ ì˜¤ë¥˜: ' + e.message;
          document.getElementById('loading-message').classList.add('hidden');
        }
      })();
    }

    init();
  </script>
</body>
</html>
