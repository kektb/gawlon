<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìˆ˜ì—… ì‹œê°„í‘œ êµê³¼ëª© ê³µë™ ì…ë ¥ ì‹œìŠ¤í…œ (10/27 ~ 11/14)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; }
    .grid-cell { padding:4px; border:1px solid #e5e7eb; text-align:center; font-size:.85rem; }
    .header-cell { background:#1f2937; color:#fff; font-weight:600; padding:10px 4px; }
    .subject-input { padding:4px 8px; border:1px solid #d1d5db; border-radius:.375rem; font-size:.8rem; width:100%; transition:.2s; }
    .subject-input:focus { outline:0; border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.5); }
    .header-cell.sticky-top { position:sticky; top:0; z-index:15; }
    .header-cell.sticky-col-1 { left:0; z-index:20; }
    .header-cell.sticky-col-2 { left:80px; z-index:20; }
    .grid-cell.sticky-col-1 { position:sticky; left:0; z-index:5; background:#f3f4f6; border-right:1px solid #e5e7eb; }
    .grid-cell.sticky-col-2 { position:sticky; left:80px; z-index:5; background:#f3f4f6; border-right:1px solid #e5e7eb; }
    @media (max-width: 768px){ .grade-input-group{display:flex;flex-direction:column;gap:4px} }
    /* ì—ëŸ¬/ìƒíƒœ ì˜¤ë²„ë ˆì´ */
    #fatal { display:none; position:fixed; left:0; right:0; top:0; padding:10px 14px; background:#fee2e2; color:#991b1b; border-bottom:1px solid #fecaca; z-index:10000; font-size:.9rem; white-space:pre-wrap; }
    .badge { padding:2px 8px; border-radius:9999px; font-size:.7rem; font-weight:600 }
    .ok { background:#dcfce7; color:#166534 }
    .warn { background:#fef9c3; color:#854d0e }
    .err { background:#fee2e2; color:#991b1b }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-8">
  <!-- Fatal error overlay -->
  <div id="fatal"></div>

  <!-- Toast -->
  <div id="toast" class="fixed top-5 right-5 text-white px-4 py-2 rounded-lg shadow" style="opacity:0;transition:.3s"></div>

  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
    <header class="mb-6 border-b pb-4 flex justify-between items-center flex-wrap gap-4">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸ—“ï¸ ìˆ˜ì—… ì‹œê°„í‘œ êµê³¼ëª© ê³µë™ ì…ë ¥ ì‹œìŠ¤í…œ</h1>
        <p class="text-gray-600 text-sm">
          <strong>ê¸°ê°„:</strong> 2025ë…„ 10ì›” 27ì¼ (ì›”) ~ 11ì›” 14ì¼ (ê¸ˆ) (ì´ 15ì¼) |
          <strong>ì‹œê°„:</strong> 1~6êµì‹œ, 40ë¶„ ìˆ˜ì—…
        </p>
      </div>
      <button onclick="exportScheduleToMarkdown()"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 shrink-0">
        ğŸ’¾ ìŠ¤ì¼€ì¤„ ë‚´ë³´ë‚´ê¸° (ë§ˆí¬ë‹¤ìš´)
      </button>
    </header>

    <div class="mt-2 mb-6 text-sm p-4 border rounded-lg bg-gray-50">
      <p class="font-medium flex flex-wrap items-center gap-2">
        í™˜ê²½ ëª¨ë“œ: <span id="env-mode" class="font-mono text-gray-700 bg-gray-200 px-2 py-0.5 rounded-md text-xs">í™•ì¸ ì¤‘...</span>
        | ì‚¬ìš©ì ID: <span id="user-id" class="font-mono text-blue-600 bg-blue-100 px-2 py-0.5 rounded-md text-xs">-</span>
        | ì—°ê²° ìƒíƒœ: <span id="conn" class="badge warn">ì´ˆê¸°í™”ì¤‘</span>
        | ë™ê¸°í™”: <span id="sync" class="badge warn">ëŒ€ê¸°</span>
      </p>
      <p class="mt-1">ì¸ì¦ ìƒíƒœ: <span id="auth-status" class="text-red-500 font-semibold">ì´ˆê¸°í™” ì¤‘...</span></p>
      <div id="error-message" class="hidden text-center py-2 text-red-600 font-semibold mt-2 border-t border-red-300"></div>
    </div>

    <div id="schedule-container" class="schedule-grid grid border border-gray-200 rounded-lg overflow-x-auto min-h-[240px]"></div>

    <footer class="mt-8 pt-4 border-t text-sm text-gray-500 text-center">
      <p>ëª¨ë“  ë³€ê²½ ì‚¬í•­ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥ ë° ê³µìœ ë©ë‹ˆë‹¤. êµê³¼ëª© ì…ë ¥ í›„ ì—”í„°(Enter)ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ë‹¤ë¥¸ ì¹¸ì„ ì„ íƒí•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤.</p>
    </footer>
  </div>

  <!-- ì—ëŸ¬/í† ìŠ¤íŠ¸ ìœ í‹¸ -->
  <script>
    window.addEventListener('error', (e) => {
      const el = document.getElementById('fatal');
      el.style.display = 'block';
      el.textContent = 'ì˜¤ë¥˜: ' + (e.error?.message || e.message);
      document.getElementById('conn').className='badge err'; document.getElementById('conn').textContent='ì˜¤ë¥˜';
    });
    window.addEventListener('unhandledrejection', (e) => {
      const el = document.getElementById('fatal');
      el.style.display = 'block';
      el.textContent = 'ì˜¤ë¥˜(ë¹„ë™ê¸°): ' + (e.reason?.message || String(e.reason));
      document.getElementById('conn').className='badge err'; document.getElementById('conn').textContent='ì˜¤ë¥˜';
    });
    window.toast = (msg, ok=true) => {
      const t=document.getElementById('toast');
      t.textContent=msg; t.style.backgroundColor = ok ? '#10b981' : '#ef4444';
      t.style.opacity='1'; setTimeout(()=> t.style.opacity='0', 3000);
    };
    window.getDayName = (ds) => ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(ds).getDay()];
  </script>

  <!-- ë©”ì¸ ëª¨ë“ˆ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== ì„¤ì • =====
    const EXTERNAL_FIREBASE_CONFIG = {
      apiKey: "AIzaSyDyiPpRmnm1hZWsHAlD860AuhGcdJKEfC4",
      authDomain: "galwon.firebaseapp.com",
      projectId: "galwon",
      storageBucket: "galwon.appspot.com",   // <- í˜•ì‹ ë³´ì • (appspot.com)
      messagingSenderId: "165546187721",
      appId: "1:165546187721:web:4ea575eaf31523096f2618",
      measurementId: "G-PXSRPV7ZWM"
    };
    const isCanvas = typeof window.__firebase_config !== 'undefined';
    const firebaseConfig = isCanvas ? JSON.parse(window.__firebase_config || '{}') : EXTERNAL_FIREBASE_CONFIG;
    const appId = isCanvas ? (window.__app_id || firebaseConfig.projectId || 'default-app-id-canvas')
                           : (firebaseConfig.projectId || 'default-app-id-external');

    // âœ… ìœ íš¨í•œ Firestore ê²½ë¡œ (col/doc/col/doc/col/doc)
    const SCHEDULE_DOC_PATH = `artifacts/${appId}/public/data/class_schedule/schedule_data`;

    const GRADE_LIST = ['2í•™ë…„','3í•™ë…„','4í•™ë…„','5í•™ë…„','6í•™ë…„'];
    const PERIOD_TIMES = { '1':'09:00~09:40','2':'09:50~10:30','3':'10:40~11:20','4':'11:30~12:10','5':'01:00~01:40','6':'01:40~02:20' };

    function daysInRange(){
      const out=[]; let d=new Date('2025-10-27T00:00:00'); const end=new Date('2025-11-14T00:00:00');
      while(d<=end){ const w=d.getDay(); if(w>=1&&w<=5){ out.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`); } d.setDate(d.getDate()+1); }
      return out;
    }
    const ALL_DATES = daysInRange();

    function buildInitial(){
      const init={};
      ALL_DATES.forEach(date=>{
        init[date]={};
        for(let p=1;p<=6;p++){
          const row={}; GRADE_LIST.forEach(g=>row[g]=''); init[date][p]=row;
        }
      });
      return init;
    }

    // ===== ì „ì—­ ìƒíƒœ =====
    let app, db, auth, current = {};

    // ===== ë‚™ê´€ì  ì¦‰ì‹œ ë Œë” =====
    function render(data){
      const c = document.getElementById('schedule-container');
      c.innerHTML='';
      c.style.display='grid';
      c.style.gridTemplateColumns=`80px 80px repeat(${ALL_DATES.length}, minmax(200px, 1fr))`;

      let header = `<div class="header-cell sticky-top sticky-col-1">êµì‹œ</div>`;
      header += `<div class="header-cell sticky-top sticky-col-2">ì‹œê°„</div>`;
      ALL_DATES.forEach(date=>{
        header += `<div class="header-cell sticky-top">${date.slice(5).replace('-','/')} (${window.getDayName(date)})</div>`;
      });
      c.insertAdjacentHTML('beforeend', header);

      for(let p=1;p<=6;p++){
        c.insertAdjacentHTML('beforeend', `<div class="grid-cell sticky-col-1 bg-gray-200 font-semibold">${p}êµì‹œ</div>`);
        c.insertAdjacentHTML('beforeend', `<div class="grid-cell sticky-col-2 bg-gray-200 text-xs text-gray-600">${PERIOD_TIMES[p]}</div>`);
        ALL_DATES.forEach(date=>{
          const row = data[date]?.[p] || {};
          c.insertAdjacentHTML('beforeend', `<div class="grid-cell text-left">${inputs(date,p,row)}</div>`);
        });
        if(p===4){
          c.insertAdjacentHTML('beforeend', `
            <div class="grid-cell sticky-col-1 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">ì ì‹¬</div>
            <div class="grid-cell sticky-col-2 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">ì‹œê°„</div>`);
          ALL_DATES.forEach(()=> c.insertAdjacentHTML('beforeend', `<div class="grid-cell bg-yellow-100 text-yellow-800 font-bold text-xs py-3 border-b-2 border-yellow-400">12:10~1:00</div>`));
        }
      }
    }
    function inputs(date, period, data){
      let html='';
      GRADE_LIST.forEach(g=>{
        const v = data[g] ?? '';
        html += `
          <div class="flex items-center space-x-1 mb-1 last:mb-0">
            <label class="text-xs font-semibold text-gray-700 w-10 shrink-0">${g}:</label>
            <input type="text" value="${v}" placeholder="êµê³¼ëª©"
              title="${date.slice(5).replace('-', '/')} ${period}êµì‹œ ${g} ìˆ˜ì—…"
              data-date="${date}" data-period="${period}" data-grade="${g}"
              class="subject-input" onchange="handleChange(this)">
          </div>`;
      });
      return `<div class="grade-input-group">${html}</div>`;
    }

    // ì¦‰ì‹œ ê·¸ë¦¬ê¸° & ë¡œë”© ë¬¸êµ¬ ì œê±°
    current = buildInitial();
    render(current);
    document.getElementById('env-mode').textContent = isCanvas ? 'Canvas í™˜ê²½' : 'ì™¸ë¶€ ë¸Œë¼ìš°ì €';
    document.getElementById('auth-status').textContent = 'ì´ˆê¸°í™” ì¤‘...';
    document.getElementById('conn').textContent='ë Œë”ì™„ë£Œ'; document.getElementById('conn').className='badge ok';

    // ===== Firestore ì—°ê²° =====
    async function init(){
      try{
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        document.getElementById('conn').textContent='ì—°ê²°ë¨'; document.getElementById('conn').className='badge ok';

        if(isCanvas && typeof window.__initial_auth_token !== 'undefined'){
          await signInWithCustomToken(auth, window.__initial_auth_token);
        }else{
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user)=>{
          if(user){
            document.getElementById('user-id').textContent = user.uid;
            const s = document.getElementById('auth-status'); s.textContent='ì¸ì¦ ì™„ë£Œ'; s.classList.remove('text-red-500'); s.classList.add('text-green-500');
            startSync();
          }else{
            document.getElementById('auth-status').textContent='ì¸ì¦ ì‹¤íŒ¨';
            document.getElementById('sync').textContent='ëŒ€ê¸°'; document.getElementById('sync').className='badge warn';
          }
        });

      }catch(e){
        fatal('ì´ˆê¸°í™” ì˜¤ë¥˜: ' + e.message);
      }
    }

    function fatal(msg){
      const el=document.getElementById('fatal'); el.style.display='block'; el.textContent=msg;
      document.getElementById('conn').textContent='ì˜¤ë¥˜'; document.getElementById('conn').className='badge err';
    }

    async function startSync(){
      try{
        const ref = doc(db, SCHEDULE_DOC_PATH);
        document.getElementById('sync').textContent='ë™ê¸°í™”ì¤‘'; document.getElementById('sync').className='badge warn';

        // ë¬¸ì„œ ì—†ìœ¼ë©´ ìƒì„± ì‹œë„(ê¶Œí•œ ì—†ìœ¼ë©´ í™”ë©´ ìœ ì§€)
        const snap = await getDoc(ref);
        if(!snap.exists()){
          try{ await setDoc(ref, current); }
          catch(e){ console.warn('ì´ˆê¸° ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨:', e); window.toast('ì´ˆê¸° ë¬¸ì„œ ìƒì„± ê¶Œí•œ ì—†ìŒ â€” ì„ì‹œ í‘œë¡œ ì‘ì—… ì¤‘', false); }
        }

        onSnapshot(ref, (s)=>{
          if(s.exists()){
            current = s.data();
            render(current);
            document.getElementById('sync').textContent='ë™ê¸°í™”ì™„ë£Œ'; document.getElementById('sync').className='badge ok';
          }else{
            // ë¬¸ì„œê°€ ì•„ì§ ì—†ìœ¼ë©´ í˜„ì¬ ì„ì‹œí‘œ ìœ ì§€
            document.getElementById('sync').textContent='ë¬¸ì„œì—†ìŒ(ì„ì‹œí‘œ)'; document.getElementById('sync').className='badge warn';
          }
        }, (err)=>{
          fatal('ì‹¤ì‹œê°„ ì˜¤ë¥˜: ' + err.message);
        });

      }catch(e){
        fatal('ë™ê¸°í™” ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // ì…ë ¥ ë³€ê²½ â†’ Firestore ì—…ë°ì´íŠ¸ (ê¶Œí•œ ì—†ìœ¼ë©´ í† ìŠ¤íŠ¸ë§Œ)
    window.handleChange = async (el)=>{
      const date = el.dataset.date, period = el.dataset.period, grade = el.dataset.grade, value = el.value;
      try{
        const ref = doc(getFirestore(), SCHEDULE_DOC_PATH);
        const path = `${date}.${period}.${grade}`;   // ì (.)ë§Œ í‚¤ì— ì—†ìœ¼ë©´ ì•ˆì „
        await updateDoc(ref, { [path]: value });
        window.toast('ì €ì¥ë¨', true);
      }catch(e){
        console.warn(e); window.toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, false);
      }
    };

    // ë§ˆí¬ë‹¤ìš´ ë‚´ë³´ë‚´ê¸°
    window.exportScheduleToMarkdown = ()=>{
      let md = `## ğŸ—“ï¸ ìµœì¢… í™•ì • ìˆ˜ì—… ì‹œê°„í‘œ (2025ë…„ 10ì›” 27ì¼ ~ 11ì›” 14ì¼)\n\n`;
      md += `| êµì‹œ/ì‹œê°„ | ${ALL_DATES.map(d => d.slice(5).replace('-', '/') + ' (' + window.getDayName(d) + ')').join(' | ')} |\n`;
      md += `| :---: | ${ALL_DATES.map(()=> '---').join('|')} |\n`;
      ['1','2','3','4','5','6'].forEach(p=>{
        let row = `| ${p}êµì‹œ (${PERIOD_TIMES[p]}) |`;
        ALL_DATES.forEach(date=>{
          const pd = current[date]?.[p] || {};
          const cell = ['2í•™ë…„','3í•™ë…„','4í•™ë…„','5í•™ë…„','6í•™ë…„'].map(g=>`**${g.replace('í•™ë…„','í•™')}**: ${pd[g]||'-'}`).join(' / ');
          row += ' ' + cell + ' |';
        });
        md += row + '\n';
        if(p==='4'){ md += `| **ì ì‹¬ì‹œê°„** | ${ALL_DATES.map(()=> '**ì ì‹¬ (12:10~1:00)**').join(' | ')} |\n`; }
      });
      const ta=document.createElement('textarea'); ta.value=md; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      window.toast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', true);
    };

    // ì‹œì‘
    init();
  </script>
</body>
</html>
