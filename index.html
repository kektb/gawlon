<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>수업 시간표 교과목 공동 입력 시스템 (10/27 ~ 11/14)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; }
    .grid-cell { padding:4px; border:1px solid #e5e7eb; text-align:center; font-size:.85rem; }
    .header-cell { background:#1f2937; color:#fff; font-weight:600; padding:10px 4px; }
    .subject-input { padding:4px 8px; border:1px solid #d1d5db; border-radius:.375rem; font-size:.8rem; width:100%; transition:.2s; }
    .subject-input:focus { outline:0; border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.5); }
    .header-cell.sticky-top { position:sticky; top:0; z-index:15; }
    .header-cell.sticky-col-1 { left:0; z-index:20; }
    .header-cell.sticky-col-2 { left:80px; z-index:20; }
    .grid-cell.sticky-col-1 { position:sticky; left:0; z-index:5; background:#f3f4f6; border-right:1px solid #e5e7eb; }
    .grid-cell.sticky-col-2 { position:sticky; left:80px; z-index:5; background:#f3f4f6; border-right:1px solid #e5e7eb; }
    @media (max-width: 768px){ .grade-input-group{display:flex;flex-direction:column;gap:4px} }
    /* 에러/상태 오버레이 */
    #fatal { display:none; position:fixed; left:0; right:0; top:0; padding:10px 14px; background:#fee2e2; color:#991b1b; border-bottom:1px solid #fecaca; z-index:10000; font-size:.9rem; white-space:pre-wrap; }
    .badge { padding:2px 8px; border-radius:9999px; font-size:.7rem; font-weight:600 }
    .ok { background:#dcfce7; color:#166534 }
    .warn { background:#fef9c3; color:#854d0e }
    .err { background:#fee2e2; color:#991b1b }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-8">
  <!-- Fatal error overlay -->
  <div id="fatal"></div>

  <!-- Toast -->
  <div id="toast" class="fixed top-5 right-5 text-white px-4 py-2 rounded-lg shadow" style="opacity:0;transition:.3s"></div>

  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
    <header class="mb-6 border-b pb-4 flex justify-between items-center flex-wrap gap-4">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">🗓️ 수업 시간표 교과목 공동 입력 시스템</h1>
        <p class="text-gray-600 text-sm">
          <strong>기간:</strong> 2025년 10월 27일 (월) ~ 11월 14일 (금) (총 15일) |
          <strong>시간:</strong> 1~6교시, 40분 수업
        </p>
      </div>
      <button onclick="exportScheduleToMarkdown()"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 shrink-0">
        💾 스케줄 내보내기 (마크다운)
      </button>
    </header>

    <div class="mt-2 mb-6 text-sm p-4 border rounded-lg bg-gray-50">
      <p class="font-medium flex flex-wrap items-center gap-2">
        환경 모드: <span id="env-mode" class="font-mono text-gray-700 bg-gray-200 px-2 py-0.5 rounded-md text-xs">확인 중...</span>
        | 사용자 ID: <span id="user-id" class="font-mono text-blue-600 bg-blue-100 px-2 py-0.5 rounded-md text-xs">-</span>
        | 연결 상태: <span id="conn" class="badge warn">초기화중</span>
        | 동기화: <span id="sync" class="badge warn">대기</span>
      </p>
      <p class="mt-1">인증 상태: <span id="auth-status" class="text-red-500 font-semibold">초기화 중...</span></p>
      <div id="error-message" class="hidden text-center py-2 text-red-600 font-semibold mt-2 border-t border-red-300"></div>
    </div>

    <div id="schedule-container" class="schedule-grid grid border border-gray-200 rounded-lg overflow-x-auto min-h-[240px]"></div>

    <footer class="mt-8 pt-4 border-t text-sm text-gray-500 text-center">
      <p>모든 변경 사항은 실시간으로 저장 및 공유됩니다. 교과목 입력 후 엔터(Enter)를 누르거나 다른 칸을 선택하면 저장됩니다.</p>
    </footer>
  </div>

  <!-- 에러/토스트 유틸 -->
  <script>
    window.addEventListener('error', (e) => {
      const el = document.getElementById('fatal');
      el.style.display = 'block';
      el.textContent = '오류: ' + (e.error?.message || e.message);
      document.getElementById('conn').className='badge err'; document.getElementById('conn').textContent='오류';
    });
    window.addEventListener('unhandledrejection', (e) => {
      const el = document.getElementById('fatal');
      el.style.display = 'block';
      el.textContent = '오류(비동기): ' + (e.reason?.message || String(e.reason));
      document.getElementById('conn').className='badge err'; document.getElementById('conn').textContent='오류';
    });
    window.toast = (msg, ok=true) => {
      const t=document.getElementById('toast');
      t.textContent=msg; t.style.backgroundColor = ok ? '#10b981' : '#ef4444';
      t.style.opacity='1'; setTimeout(()=> t.style.opacity='0', 3000);
    };
    window.getDayName = (ds) => ['일','월','화','수','목','금','토'][new Date(ds).getDay()];
  </script>

  <!-- 메인 모듈 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== 설정 =====
    const EXTERNAL_FIREBASE_CONFIG = {
      apiKey: "AIzaSyDyiPpRmnm1hZWsHAlD860AuhGcdJKEfC4",
      authDomain: "galwon.firebaseapp.com",
      projectId: "galwon",
      storageBucket: "galwon.appspot.com",   // <- 형식 보정 (appspot.com)
      messagingSenderId: "165546187721",
      appId: "1:165546187721:web:4ea575eaf31523096f2618",
      measurementId: "G-PXSRPV7ZWM"
    };
    const isCanvas = typeof window.__firebase_config !== 'undefined';
    const firebaseConfig = isCanvas ? JSON.parse(window.__firebase_config || '{}') : EXTERNAL_FIREBASE_CONFIG;
    const appId = isCanvas ? (window.__app_id || firebaseConfig.projectId || 'default-app-id-canvas')
                           : (firebaseConfig.projectId || 'default-app-id-external');

    // ✅ 유효한 Firestore 경로 (col/doc/col/doc/col/doc)
    const SCHEDULE_DOC_PATH = `artifacts/${appId}/public/data/class_schedule/schedule_data`;

    const GRADE_LIST = ['2학년','3학년','4학년','5학년','6학년'];
    const PERIOD_TIMES = { '1':'09:00~09:40','2':'09:50~10:30','3':'10:40~11:20','4':'11:30~12:10','5':'01:00~01:40','6':'01:40~02:20' };

    function daysInRange(){
      const out=[]; let d=new Date('2025-10-27T00:00:00'); const end=new Date('2025-11-14T00:00:00');
      while(d<=end){ const w=d.getDay(); if(w>=1&&w<=5){ out.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`); } d.setDate(d.getDate()+1); }
      return out;
    }
    const ALL_DATES = daysInRange();

    function buildInitial(){
      const init={};
      ALL_DATES.forEach(date=>{
        init[date]={};
        for(let p=1;p<=6;p++){
          const row={}; GRADE_LIST.forEach(g=>row[g]=''); init[date][p]=row;
        }
      });
      return init;
    }

    // ===== 전역 상태 =====
    let app, db, auth, current = {};

    // ===== 낙관적 즉시 렌더 =====
    function render(data){
      const c = document.getElementById('schedule-container');
      c.innerHTML='';
      c.style.display='grid';
      c.style.gridTemplateColumns=`80px 80px repeat(${ALL_DATES.length}, minmax(200px, 1fr))`;

      let header = `<div class="header-cell sticky-top sticky-col-1">교시</div>`;
      header += `<div class="header-cell sticky-top sticky-col-2">시간</div>`;
      ALL_DATES.forEach(date=>{
        header += `<div class="header-cell sticky-top">${date.slice(5).replace('-','/')} (${window.getDayName(date)})</div>`;
      });
      c.insertAdjacentHTML('beforeend', header);

      for(let p=1;p<=6;p++){
        c.insertAdjacentHTML('beforeend', `<div class="grid-cell sticky-col-1 bg-gray-200 font-semibold">${p}교시</div>`);
        c.insertAdjacentHTML('beforeend', `<div class="grid-cell sticky-col-2 bg-gray-200 text-xs text-gray-600">${PERIOD_TIMES[p]}</div>`);
        ALL_DATES.forEach(date=>{
          const row = data[date]?.[p] || {};
          c.insertAdjacentHTML('beforeend', `<div class="grid-cell text-left">${inputs(date,p,row)}</div>`);
        });
        if(p===4){
          c.insertAdjacentHTML('beforeend', `
            <div class="grid-cell sticky-col-1 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">점심</div>
            <div class="grid-cell sticky-col-2 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">시간</div>`);
          ALL_DATES.forEach(()=> c.insertAdjacentHTML('beforeend', `<div class="grid-cell bg-yellow-100 text-yellow-800 font-bold text-xs py-3 border-b-2 border-yellow-400">12:10~1:00</div>`));
        }
      }
    }
    function inputs(date, period, data){
      let html='';
      GRADE_LIST.forEach(g=>{
        const v = data[g] ?? '';
        html += `
          <div class="flex items-center space-x-1 mb-1 last:mb-0">
            <label class="text-xs font-semibold text-gray-700 w-10 shrink-0">${g}:</label>
            <input type="text" value="${v}" placeholder="교과목"
              title="${date.slice(5).replace('-', '/')} ${period}교시 ${g} 수업"
              data-date="${date}" data-period="${period}" data-grade="${g}"
              class="subject-input" onchange="handleChange(this)">
          </div>`;
      });
      return `<div class="grade-input-group">${html}</div>`;
    }

    // 즉시 그리기 & 로딩 문구 제거
    current = buildInitial();
    render(current);
    document.getElementById('env-mode').textContent = isCanvas ? 'Canvas 환경' : '외부 브라우저';
    document.getElementById('auth-status').textContent = '초기화 중...';
    document.getElementById('conn').textContent='렌더완료'; document.getElementById('conn').className='badge ok';

    // ===== Firestore 연결 =====
    async function init(){
      try{
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        document.getElementById('conn').textContent='연결됨'; document.getElementById('conn').className='badge ok';

        if(isCanvas && typeof window.__initial_auth_token !== 'undefined'){
          await signInWithCustomToken(auth, window.__initial_auth_token);
        }else{
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user)=>{
          if(user){
            document.getElementById('user-id').textContent = user.uid;
            const s = document.getElementById('auth-status'); s.textContent='인증 완료'; s.classList.remove('text-red-500'); s.classList.add('text-green-500');
            startSync();
          }else{
            document.getElementById('auth-status').textContent='인증 실패';
            document.getElementById('sync').textContent='대기'; document.getElementById('sync').className='badge warn';
          }
        });

      }catch(e){
        fatal('초기화 오류: ' + e.message);
      }
    }

    function fatal(msg){
      const el=document.getElementById('fatal'); el.style.display='block'; el.textContent=msg;
      document.getElementById('conn').textContent='오류'; document.getElementById('conn').className='badge err';
    }

    async function startSync(){
      try{
        const ref = doc(db, SCHEDULE_DOC_PATH);
        document.getElementById('sync').textContent='동기화중'; document.getElementById('sync').className='badge warn';

        // 문서 없으면 생성 시도(권한 없으면 화면 유지)
        const snap = await getDoc(ref);
        if(!snap.exists()){
          try{ await setDoc(ref, current); }
          catch(e){ console.warn('초기 문서 생성 실패:', e); window.toast('초기 문서 생성 권한 없음 — 임시 표로 작업 중', false); }
        }

        onSnapshot(ref, (s)=>{
          if(s.exists()){
            current = s.data();
            render(current);
            document.getElementById('sync').textContent='동기화완료'; document.getElementById('sync').className='badge ok';
          }else{
            // 문서가 아직 없으면 현재 임시표 유지
            document.getElementById('sync').textContent='문서없음(임시표)'; document.getElementById('sync').className='badge warn';
          }
        }, (err)=>{
          fatal('실시간 오류: ' + err.message);
        });

      }catch(e){
        fatal('동기화 시작 실패: ' + e.message);
      }
    }

    // 입력 변경 → Firestore 업데이트 (권한 없으면 토스트만)
    window.handleChange = async (el)=>{
      const date = el.dataset.date, period = el.dataset.period, grade = el.dataset.grade, value = el.value;
      try{
        const ref = doc(getFirestore(), SCHEDULE_DOC_PATH);
        const path = `${date}.${period}.${grade}`;   // 점(.)만 키에 없으면 안전
        await updateDoc(ref, { [path]: value });
        window.toast('저장됨', true);
      }catch(e){
        console.warn(e); window.toast('저장 실패: ' + e.message, false);
      }
    };

    // 마크다운 내보내기
    window.exportScheduleToMarkdown = ()=>{
      let md = `## 🗓️ 최종 확정 수업 시간표 (2025년 10월 27일 ~ 11월 14일)\n\n`;
      md += `| 교시/시간 | ${ALL_DATES.map(d => d.slice(5).replace('-', '/') + ' (' + window.getDayName(d) + ')').join(' | ')} |\n`;
      md += `| :---: | ${ALL_DATES.map(()=> '---').join('|')} |\n`;
      ['1','2','3','4','5','6'].forEach(p=>{
        let row = `| ${p}교시 (${PERIOD_TIMES[p]}) |`;
        ALL_DATES.forEach(date=>{
          const pd = current[date]?.[p] || {};
          const cell = ['2학년','3학년','4학년','5학년','6학년'].map(g=>`**${g.replace('학년','학')}**: ${pd[g]||'-'}`).join(' / ');
          row += ' ' + cell + ' |';
        });
        md += row + '\n';
        if(p==='4'){ md += `| **점심시간** | ${ALL_DATES.map(()=> '**점심 (12:10~1:00)**').join(' | ')} |\n`; }
      });
      const ta=document.createElement('textarea'); ta.value=md; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      window.toast('클립보드에 복사되었습니다!', true);
    };

    // 시작
    init();
  </script>
</body>
</html>
