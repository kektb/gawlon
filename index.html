<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… ì‹œê°„í‘œ êµê³¼ëª© ê³µë™ ì…ë ¥ ì‹œìŠ¤í…œ (10/27 ~ 11/14)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© */
        :root { font-family: 'Inter', sans-serif; }
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ */
        .grid-cell {
            padding: 4px; /* ì…€ ë‚´ë¶€ íŒ¨ë”© ì¡°ì • */
            border: 1px solid #e5e7eb;
            text-align: center;
            font-size: 0.85rem;
        }
        .header-cell {
            background-color: #1f2937;
            color: white;
            font-weight: 600;
            padding: 10px 4px;
        }
        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .subject-input {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }
        .subject-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        /* í´ë¦½ë³´ë“œ ë³µì‚¬ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #10b981; /* green-500 */
            color: white;
            padding: 12px 24px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }
        .show { opacity: 1 !important; }

        /* --- Sticky Column Styles for Horizontal Scroll --- */
        .header-cell.sticky-top {
            position: sticky;
            top: 0;
            z-index: 15; /* Below combined header (z-index 20) */
        }
        .header-cell.sticky-col-1 {
            left: 0;
            z-index: 20; /* Highest for the top-left corner cell */
        }
        .header-cell.sticky-col-2 {
            left: 80px; /* Width of col-1 */
            z-index: 20;
        }
        .grid-cell.sticky-col-1 {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #f3f4f6;
            border-right: 1px solid #e5e7eb;
        }
        .grid-cell.sticky-col-2 {
            position: sticky;
            left: 80px;
            z-index: 5;
            background-color: #f3f4f6;
            border-right: 1px solid #e5e7eb;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .grade-input-group { display: flex; flex-direction: column; gap: 4px; }
            .subject-input { font-size: 0.8rem; }
        }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc, setLogLevel, FieldPath
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        let app;
        let db;
        let auth;
        let userId = 'loading';
        let currentScheduleData = {}; // í˜„ì¬ ì‹œê°„í‘œ ë°ì´í„°ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

        // *******************************************************************
        // ****** âš ï¸ ì™¸ë¶€ ë¸Œë¼ìš°ì € ë°°í¬ë¥¼ ìœ„í•œ ì„¤ì • (Canvas í™˜ê²½ì—ì„œëŠ” ìë™ ë¬´ì‹œë¨) ******
        // *******************************************************************
        const EXTERNAL_FIREBASE_CONFIG = {
            // ğŸ‘‡ ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì • ğŸ‘‡
            apiKey: "AIzaSyDyiPpRmnm1hZWsHAlD860AuhGcdJKEfC4",
            authDomain: "galwon.firebaseapp.com",
            projectId: "galwon",
            storageBucket: "galwon.firebasestorage.app", // (í˜„ì¬ ì½”ë“œì—ì„œëŠ” ì‚¬ìš© X)
            messagingSenderId: "165546187721",
            appId: "1:165546187721:web:4ea575eaf31523096f2618",
            measurementId: "G-PXSRPV7ZWM"
        };

        // Canvas vs ì™¸ë¶€ ë¸Œë¼ìš°ì € í™˜ê²½ íŒë³„
        const isCanvasEnvironment = typeof __firebase_config !== 'undefined';
        const firebaseConfig = isCanvasEnvironment
            ? (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {})
            : EXTERNAL_FIREBASE_CONFIG;

        const appId = isCanvasEnvironment
            ? (typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id-canvas')
            : (firebaseConfig.projectId || 'default-app-id-external');

        // âœ… Firestore ë¬¸ì„œ ê²½ë¡œ: ì„ í–‰ ìŠ¬ë˜ì‹œ ì œê±°!
        const SCHEDULE_DOC_PATH = `artifacts/${appId}/public/data/class_schedule/schedule_data`;

        // Grades used for input fields
        const GRADE_LIST = ['2í•™ë…„', '3í•™ë…„', '4í•™ë…„', '5í•™ë…„', '6í•™ë…„'];

        // Time slots
        const PERIOD_TIMES = {
            '1': '09:00~09:40',
            '2': '09:50~10:30',
            '3': '10:40~11:20',
            '4': '11:30~12:10',
            '5': '01:00~01:40',
            '6': '01:40~02:20'
        };

        // Date generation (10/27/2025 to 11/14/2025, skipping weekends)
        function generateDates() {
            const dates = [];
            let currentDate = new Date('2025-10-27T00:00:00');
            const endDate = new Date('2025-11-14T00:00:00');

            while (currentDate <= endDate) {
                const day = currentDate.getDay();
                // 1=ì›”, 2=í™”, 3=ìˆ˜, 4=ëª©, 5=ê¸ˆ
                if (day >= 1 && day <= 5) {
                    const yyyy = currentDate.getFullYear();
                    const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const dd = String(currentDate.getDate()).padStart(2, '0');
                    dates.push(`${yyyy}-${mm}-${dd}`);
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        const ALL_DATES = generateDates();

        // Utility function to get day name
        function getDayName(dateString) {
            const date = new Date(dateString);
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            return days[date.getDay()];
        }

        // --- Firebase Initialization and Auth ---
        async function initFirebase() {
            // setLogLevel('debug'); // í•„ìš” ì‹œ ì½˜ì†” ìƒì„¸ ë¡œê·¸
            document.getElementById('env-mode').textContent = isCanvasEnvironment ? 'Canvas í™˜ê²½' : 'ì™¸ë¶€ ë¸Œë¼ìš°ì €';

            try {
                if (!isCanvasEnvironment && (firebaseConfig.apiKey === "" || firebaseConfig.projectId === "")) {
                    throw new Error("EXTERNAL_FIREBASE_CONFIGì— apiKeyì™€ projectIdë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (isCanvasEnvironment && typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        document.getElementById('auth-status').textContent = 'ì¸ì¦ ì™„ë£Œ';
                        document.getElementById('auth-status').classList.remove('text-red-500');
                        document.getElementById('auth-status').classList.add('text-green-500');
                        startScheduleListener();
                    } else {
                        document.getElementById('auth-status').textContent = 'ì¸ì¦ ì‹¤íŒ¨';
                        document.getElementById('auth-status').classList.add('text-red-500');
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                document.getElementById('auth-status').textContent = 'ì´ˆê¸°í™” ì˜¤ë¥˜';
                document.getElementById('auth-status').classList.add('text-red-500', 'font-bold');
                document.getElementById('error-message').innerHTML = `
                    <div class="font-bold">ì¸ì¦ ì‹¤íŒ¨: ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ</div>
                    <div class="mt-1">${error.message}</div>
                `;
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('loading-message').classList.add('hidden');
            }
        }

        // --- Firestore Realtime Data Listener ---
        function startScheduleListener() {
            const docRef = doc(db, SCHEDULE_DOC_PATH);

            // ìµœì´ˆ ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒì„±
            getDoc(docRef).then(async (docSnap) => {
                if (!docSnap.exists()) {
                    const initialData = {};
                    ALL_DATES.forEach(date => {
                        initialData[date] = {};
                        for (let p = 1; p <= 6; p++) {
                            const periodData = {};
                            GRADE_LIST.forEach(grade => { periodData[grade] = ''; });
                            initialData[date][p] = periodData;
                        }
                    });
                    try {
                        await setDoc(docRef, initialData);
                    } catch (e) {
                        console.error("ì´ˆê¸° ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨:", e);
                    }
                }
            }).catch(e => console.error("ë¬¸ì„œ í™•ì¸ ì¤‘ ì˜¤ë¥˜:", e));

            // ì‹¤ì‹œê°„ êµ¬ë…
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentScheduleData = docSnap.data();
                    renderSchedule(currentScheduleData);
                    document.getElementById('loading-message').classList.add('hidden');
                }
            }, (error) => {
                console.error("ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                document.getElementById('error-message').textContent = `ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: ${error.message}`;
                document.getElementById('error-message').classList.remove('hidden');
            });
        }

        // --- UI Rendering ---
        function renderSchedule(scheduleData) {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';

            // sticky ì—´ì´ ì •í™•íˆ ë™ì‘í•˜ë„ë¡ ëª…ì‹œì ì¸ ê·¸ë¦¬ë“œ ì„¤ì •
            container.style.display = 'grid';
            container.style.gridTemplateColumns = `80px 80px repeat(${ALL_DATES.length}, minmax(200px, 1fr))`;

            // Header Row
            let headerHtml = `<div class="header-cell sticky-top sticky-col-1">êµì‹œ</div>`;
            headerHtml += `<div class="header-cell sticky-top sticky-col-2">ì‹œê°„</div>`;
            ALL_DATES.forEach(date => {
                const dayName = getDayName(date);
                headerHtml += `<div class="header-cell sticky-top day-header">${date.slice(5).replace('-', '/')} (${dayName})</div>`;
            });
            container.innerHTML += headerHtml;

            // Period Rows (1~6)
            for (let period = 1; period <= 6; period++) {
                container.innerHTML += `<div class="grid-cell sticky-col-1 bg-gray-200 font-semibold">${period}êµì‹œ</div>`;
                container.innerHTML += `<div class="grid-cell sticky-col-2 bg-gray-200 text-xs text-gray-600">${PERIOD_TIMES[period]}</div>`;

                ALL_DATES.forEach(date => {
                    const periodData = scheduleData[date]?.[period] || {};
                    const inputHtml = createInputElements(date, period, periodData);
                    container.innerHTML += `<div class="grid-cell text-left">${inputHtml}</div>`;
                });

                // 4êµì‹œ ë’¤ ì ì‹¬ ì•ˆë‚´ ì¤„
                if (period === 4) {
                    const lunchHtmlSticky = `
                        <div class="grid-cell sticky-col-1 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">ì ì‹¬</div>
                        <div class="grid-cell sticky-col-2 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">ì‹œê°„</div>
                    `;
                    container.innerHTML += lunchHtmlSticky;
                    ALL_DATES.forEach(() => {
                        container.innerHTML += `<div class="grid-cell bg-yellow-100 text-yellow-800 font-bold text-xs py-3 border-b-2 border-yellow-400">12:10~1:00</div>`;
                    });
                }
            }
        }

        function createInputElements(date, period, periodData) {
            let inputsHtml = '';
            GRADE_LIST.forEach(grade => {
                const subject = periodData[grade] || '';
                inputsHtml += `
                    <div class="flex items-center space-x-1 mb-1 last:mb-0">
                        <label class="text-xs font-semibold text-gray-700 w-10 shrink-0">${grade}:</label>
                        <input
                            type="text"
                            value="${subject}"
                            placeholder="êµê³¼ëª©"
                            title="${date.slice(5).replace('-', '/')} ${period}êµì‹œ ${grade} ìˆ˜ì—…"
                            data-date="${date}"
                            data-period="${period}"
                            data-grade="${grade}"
                            onchange="handleInputChange(this)"
                            class="subject-input"
                        >
                    </div>
                `;
            });
            return `<div class="grade-input-group">${inputsHtml}</div>`;
        }

        // --- Firestore Update Handler ---
        window.handleInputChange = async function(inputElement) {
            const date = inputElement.getAttribute('data-date');
            const period = inputElement.getAttribute('data-period');
            const grade = inputElement.getAttribute('data-grade');
            const newValue = inputElement.value;

            if (!db) {
                showNotification("ì˜¤ë¥˜: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", false);
                return;
            }

            const docRef = doc(db, SCHEDULE_DOC_PATH);

            try {
