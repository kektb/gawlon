<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìˆ˜ì—… ì‹œê°„í‘œ êµê³¼ëª© ê³µë™ ì…ë ¥ ì‹œìŠ¤í…œ (10/27 ~ 11/14)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { font-family: 'Inter', sans-serif; }
    .grid-cell {
      padding: 4px;
      border: 1px solid #e5e7eb;
      text-align: center;
      font-size: 0.85rem;
    }
    .header-cell {
      background-color: #1f2937;
      color: white;
      font-weight: 600;
      padding: 10px 4px;
    }
    .subject-input {
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      width: 100%;
      transition: all 0.2s;
    }
    .subject-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59,130,246,.5);
    }
    #notification {
      position: fixed; top: 20px; right: 20px;
      background-color: #10b981; color: white;
      padding: 12px 24px; border-radius: .5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      opacity: 0; transition: opacity .3s ease-in-out;
      z-index: 1000;
    }
    .show { opacity: 1 !important; }

    /* Sticky */
    .header-cell.sticky-top { position: sticky; top: 0; z-index: 15; }
    .header-cell.sticky-col-1 { left: 0; z-index: 20; }
    .header-cell.sticky-col-2 { left: 80px; z-index: 20; }
    .grid-cell.sticky-col-1 {
      position: sticky; left: 0; z-index: 5;
      background-color: #f3f4f6; border-right: 1px solid #e5e7eb;
    }
    .grid-cell.sticky-col-2 {
      position: sticky; left: 80px; z-index: 5;
      background-color: #f3f4f6; border-right: 1px solid #e5e7eb;
    }

    @media (max-width: 768px) {
      .grade-input-group { display: flex; flex-direction: column; gap: 4px; }
      .subject-input { font-size: .8rem; }
    }
  </style>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc, setLogLevel, FieldPath
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // =================== ê¸€ë¡œë²Œ ìƒíƒœ ===================
    let app, db, auth;
    let userId = 'loading';
    let currentScheduleData = {};

    // ===== ì™¸ë¶€ ë¸Œë¼ìš°ì €ìš© Firebase ì„¤ì • (Canvas ì™¸ë¶€ì—ì„œë§Œ ì‚¬ìš©) =====
    const EXTERNAL_FIREBASE_CONFIG = {
      apiKey: "AIzaSyDyiPpRmnm1hZWsHAlD860AuhGcdJKEfC4",
      authDomain: "galwon.firebaseapp.com",
      projectId: "galwon",
      storageBucket: "galwon.firebasestorage.app",
      messagingSenderId: "165546187721",
      appId: "1:165546187721:web:4ea575eaf31523096f2618",
      measurementId: "G-PXSRPV7ZWM"
    };

    // í™˜ê²½ íŒë³„
    const isCanvasEnvironment = typeof __firebase_config !== 'undefined';
    const firebaseConfig = isCanvasEnvironment
      ? (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {})
      : EXTERNAL_FIREBASE_CONFIG;

    const appId = isCanvasEnvironment
      ? (typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id-canvas')
      : (firebaseConfig.projectId || 'default-app-id-external');

    // âœ… ì„ í–‰ ìŠ¬ë˜ì‹œ ì œê±°ëœ Firestore ë¬¸ì„œ ê²½ë¡œ
    const SCHEDULE_DOC_PATH = `artifacts/${appId}/public/data/class_schedule/schedule_data`;

    // í•™ë…„ / êµì‹œ-ì‹œê°„
    const GRADE_LIST = ['2í•™ë…„', '3í•™ë…„', '4í•™ë…„', '5í•™ë…„', '6í•™ë…„'];
    const PERIOD_TIMES = {
      '1': '09:00~09:40',
      '2': '09:50~10:30',
      '3': '10:40~11:20',
      '4': '11:30~12:10',
      '5': '01:00~01:40',
      '6': '01:40~02:20'
    };

    // ê¸°ê°„ ë‚´ í‰ì¼ ë‚ ì§œ ìƒì„±
    function generateDates() {
      const dates = [];
      let currentDate = new Date('2025-10-27T00:00:00');
      const endDate = new Date('2025-11-14T00:00:00');
      while (currentDate <= endDate) {
        const day = currentDate.getDay(); // 0=ì¼, 6=í† 
        if (day >= 1 && day <= 5) {
          const yyyy = currentDate.getFullYear();
          const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
          const dd = String(currentDate.getDate()).padStart(2, '0');
          dates.push(`${yyyy}-${mm}-${dd}`);
        }
        currentDate.setDate(currentDate.getDate() + 1);
      }
      return dates;
    }
    const ALL_DATES = generateDates();

    function getDayName(dateString) {
      const date = new Date(dateString);
      const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      return days[date.getDay()];
    }

    // =================== Firebase ì´ˆê¸°í™” ===================
    async function initFirebase() {
      // setLogLevel('debug');
      document.getElementById('env-mode').textContent = isCanvasEnvironment ? 'Canvas í™˜ê²½' : 'ì™¸ë¶€ ë¸Œë¼ìš°ì €';

      try {
        if (!isCanvasEnvironment && (!firebaseConfig.apiKey || !firebaseConfig.projectId)) {
          throw new Error("EXTERNAL_FIREBASE_CONFIGì— apiKeyì™€ projectIdë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•˜ì„¸ìš”.");
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        if (isCanvasEnvironment && typeof __initial_auth_token !== 'undefined') {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            document.getElementById('user-id').textContent = userId;
            const s = document.getElementById('auth-status');
            s.textContent = 'ì¸ì¦ ì™„ë£Œ';
            s.classList.remove('text-red-500');
            s.classList.add('text-green-500');
            startScheduleListener();
          } else {
            document.getElementById('auth-status').textContent = 'ì¸ì¦ ì‹¤íŒ¨';
          }
        });

      } catch (error) {
        console.error("Firebase ì´ˆê¸°í™”/ì¸ì¦ ì˜¤ë¥˜:", error);
        document.getElementById('auth-status').textContent = 'ì´ˆê¸°í™” ì˜¤ë¥˜';
        document.getElementById('auth-status').classList.add('text-red-500', 'font-bold');
        document.getElementById('error-message').innerHTML = `
          <div class="font-bold">ì¸ì¦ ì‹¤íŒ¨: ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ</div>
          <div class="mt-1">${error.message}</div>`;
        document.getElementById('error-message').classList.remove('hidden');
        document.getElementById('loading-message').classList.add('hidden');
      }
    }

    // ì´ˆê¸° ë°ì´í„° êµ¬ì„± (ë¬¸ì„œê°€ ì—†ì–´ë„ í™”ë©´ì„ ê·¸ë¦¬ê¸° ìœ„í•¨)
    function buildInitialData() {
      const init = {};
      ALL_DATES.forEach(date => {
        init[date] = {};
        for (let p = 1; p <= 6; p++) {
          const periodData = {};
          GRADE_LIST.forEach(g => periodData[g] = '');
          init[date][p] = periodData;
        }
      });
      return init;
    }

    // =================== ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ===================
    function startScheduleListener() {
      const docRef = doc(db, SCHEDULE_DOC_PATH);

      (async () => {
        try {
          const docSnap = await getDoc(docRef);

          // (1) ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ë§Œë“¤ì–´ë³´ê¸°
          if (!docSnap.exists()) {
            const initialData = buildInitialData();
            try {
              await setDoc(docRef, initialData);
            } catch (e) {
              // ì“°ê¸° ê¶Œí•œì´ ì—†ìœ¼ë©´ ì„ì‹œ í‘œë¥¼ ë¨¼ì € ê·¸ë ¤ì£¼ê³  ì•Œë¦¼
              console.warn('ì´ˆê¸° ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨(ê¶Œí•œ ë“±):', e);
              currentScheduleData = initialData;
              renderSchedule(currentScheduleData);
              document.getElementById('loading-message').classList.add('hidden');
              showNotification('ì´ˆê¸° ë¬¸ì„œë¥¼ ë§Œë“¤ ê¶Œí•œì´ ì—†ì–´ ì„ì‹œ í‘œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. Firestore ê·œì¹™ì—ì„œ ì“°ê¸° ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.', false);
            }
          }

          // (2) ì‹¤ì‹œê°„ êµ¬ë…
          onSnapshot(docRef, (snap) => {
            if (snap.exists()) {
              currentScheduleData = snap.data();
              renderSchedule(currentScheduleData);
              document.getElementById('loading-message').classList.add('hidden');
            } else {
              // ì½ê¸°ëŠ” ë˜ì§€ë§Œ ë¬¸ì„œê°€ ì—¬ì „íˆ ì—†ìŒ â†’ ì„ì‹œ í‘œ ìœ ì§€
              if (Object.keys(currentScheduleData).length === 0) {
                currentScheduleData = buildInitialData();
                renderSchedule(currentScheduleData);
                document.getElementById('loading-message').classList.add('hidden');
                showNotification('ë¬¸ì„œê°€ ì—†ì–´ ì„ì‹œ í‘œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ì´ˆê¸°í™” ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.', false);
              }
            }
          }, (error) => {
            console.error('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            document.getElementById('error-message').textContent = `ë°ì´í„° ë¡œë”© ì˜¤ë¥˜: ${error.message}`;
            document.getElementById('error-message').classList.remove('hidden');
            document.getElementById('loading-message').classList.add('hidden');
          });

        } catch (e) {
          console.error('ë¬¸ì„œ í™•ì¸ ì˜¤ë¥˜:', e);
          document.getElementById('error-message').textContent = `ë¬¸ì„œ í™•ì¸ ì˜¤ë¥˜: ${e.message}`;
          document.getElementById('error-message').classList.remove('hidden');
          document.getElementById('loading-message').classList.add('hidden');
        }
      })();
    }

    // =================== ë Œë”ë§ ===================
    function renderSchedule(scheduleData) {
      const container = document.getElementById('schedule-container');
      container.innerHTML = '';
      container.style.display = 'grid';
      container.style.gridTemplateColumns = `80px 80px repeat(${ALL_DATES.length}, minmax(200px, 1fr))`;

      // í—¤ë”
      let headerHtml = `<div class="header-cell sticky-top sticky-col-1">êµì‹œ</div>`;
      headerHtml += `<div class="header-cell sticky-top sticky-col-2">ì‹œê°„</div>`;
      ALL_DATES.forEach(date => {
        const dayName = getDayName(date);
        headerHtml += `<div class="header-cell sticky-top day-header">${date.slice(5).replace('-', '/')} (${dayName})</div>`;
      });
      container.innerHTML += headerHtml;

      // êµì‹œë³„ í–‰
      for (let period = 1; period <= 6; period++) {
        container.innerHTML += `<div class="grid-cell sticky-col-1 bg-gray-200 font-semibold">${period}êµì‹œ</div>`;
        container.innerHTML += `<div class="grid-cell sticky-col-2 bg-gray-200 text-xs text-gray-600">${PERIOD_TIMES[period]}</div>`;

        ALL_DATES.forEach(date => {
          const periodData = scheduleData[date]?.[period] || {};
          const inputHtml = createInputElements(date, period, periodData);
          container.innerHTML += `<div class="grid-cell text-left">${inputHtml}</div>`;
        });

        if (period === 4) {
          container.innerHTML += `
            <div class="grid-cell sticky-col-1 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">ì ì‹¬</div>
            <div class="grid-cell sticky-col-2 bg-yellow-100 text-yellow-800 font-bold text-xs py-3 text-center border-b-2 border-yellow-400">ì‹œê°„</div>`;
          ALL_DATES.forEach(() => {
            container.innerHTML += `<div class="grid-cell bg-yellow-100 text-yellow-800 font-bold text-xs py-3 border-b-2 border-yellow-400">12:10~1:00</div>`;
          });
        }
      }
    }

    function createInputElements(date, period, periodData) {
      let inputsHtml = '';
      GRADE_LIST.forEach(grade => {
        const subject = periodData[grade] || '';
        inputsHtml += `
          <div class="flex items-center space-x-1 mb-1 last:mb-0">
            <label class="text-xs font-semibold text-gray-700 w-10 shrink-0">${grade}:</label>
            <input
              type="text"
              value="${subject}"
              placeholder="êµê³¼ëª©"
              title="${date.slice(5).replace('-', '/')} ${period}êµì‹œ ${grade} ìˆ˜ì—…"
              data-date="${date}"
              data-period="${period}"
              data-grade="${grade}"
              onchange="handleInputChange(this)"
              class="subject-input"
            >
          </div>`;
      });
      return `<div class="grade-input-group">${inputsHtml}</div>`;
    }

    // =================== ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬ ===================
    window.handleInputChange = async function(inputElement) {
      const date = inputElement.getAttribute('data-date');
      const period = inputElement.getAttribute('data-period');
      const grade = inputElement.getAttribute('data-grade');
      const newValue = inputElement.value;

      if (!db) {
        showNotification("ì˜¤ë¥˜: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", false);
        return;
      }
      const docRef = doc(db, SCHEDULE_DOC_PATH);

      try {
        // âœ… FieldPathë¡œ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸ (í•œê¸€/ê³µë°±/ê¸°í˜¸ í¬í•¨ í‚¤)
        const fp = new FieldPath(date, String(period), grade);
        await updateDoc(docRef, fp, newValue);
      } catch (e) {
        console.error("ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
        showNotification(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${e.message}`, false);
      }
    };

    // =================== ë§ˆí¬ë‹¤ìš´ ë‚´ë³´ë‚´ê¸° ===================
    window.exportScheduleToMarkdown = function() {
      if (Object.keys(currentScheduleData).length === 0) {
        showNotification("ì˜¤ë¥˜: ì €ì¥ëœ ì‹œê°„í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", false);
        return;
      }
      let md = `## ğŸ—“ï¸ ìµœì¢… í™•ì • ìˆ˜ì—… ì‹œê°„í‘œ (2025ë…„ 10ì›” 27ì¼ ~ 11ì›” 14ì¼)\n\n`;
      md += `| êµì‹œ/ì‹œê°„ | ${ALL_DATES.map(d => d.slice(5).replace('-', '/') + ' (' + getDayName(d) + ')').join(' | ')} |\n`;
      md += `| :---: | ${ALL_DATES.map(()=>'---').join('|')} |\n`;

      ['1','2','3','4','5','6'].forEach(p => {
        let row = `| ${p}êµì‹œ (${PERIOD_TIMES[p]}) |`;
        ALL_DATES.forEach(date => {
          const periodData = currentScheduleData[date]?.[p] || {};
          let cell = '';
          GRADE_LIST.forEach(grade => {
            const subject = periodData[grade] || '-';
            cell += `**${grade.replace('í•™ë…„','í•™')}**: ${subject} / `;
          });
          cell = cell.trim().slice(0, -1);
          row += ` ${cell} |`;
        });
        md += row + '\n';

        if (p === '4') {
          const lunchCells = ALL_DATES.map(() => `**ì ì‹¬ (12:10~1:00)**`).join(' | ');
          md += `| **ì ì‹¬ì‹œê°„** | ${lunchCells} |\n`;
        }
      });

      try {
        const ta = document.createElement('textarea');
        ta.value = md; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        showNotification("ì‹œê°„í‘œ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!", true);
      } catch (err) {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
        showNotification("í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
      }
    };

    // =================== í† ìŠ¤íŠ¸ ===================
    function showNotification(message, success) {
      const n = document.getElementById('notification');
      n.textContent = message;
      n.style.backgroundColor = success ? '#10b981' : '#ef4444';
      n.classList.add('show');
      setTimeout(() => n.classList.remove('show'), 3000);
    }

    // ì‹œì‘
    window.onload = initFirebase;
  </script>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-8">
  <!-- Notification Toast -->
  <div id="notification"></div>

  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
    <header class="mb-8 border-b pb-4 flex justify-between items-center flex-wrap gap-4">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸ—“ï¸ ìˆ˜ì—… ì‹œê°„í‘œ êµê³¼ëª© ê³µë™ ì…ë ¥ ì‹œìŠ¤í…œ</h1>
        <p class="text-gray-600 text-sm">
          **ê¸°ê°„:** 2025ë…„ 10ì›” 27ì¼ (ì›”) ~ 11ì›” 14ì¼ (ê¸ˆ) (ì´ 15ì¼) | **ì‹œê°„:** 1~6êµì‹œ, 40ë¶„ ìˆ˜ì—…
        </p>
      </div>
      <button onclick="exportScheduleToMarkdown()"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 shrink-0">
        ğŸ’¾ ìŠ¤ì¼€ì¤„ ë‚´ë³´ë‚´ê¸° (ë§ˆí¬ë‹¤ìš´)
      </button>
    </header>

    <div class="mt-4 mb-8 text-sm p-4 border rounded-lg bg-gray-50">
      <p class="font-medium">
        í™˜ê²½ ëª¨ë“œ: <span id="env-mode" class="font-mono text-gray-700 bg-gray-200 p-1 rounded-md text-xs">í™•ì¸ ì¤‘...</span>
        | ì‚¬ìš©ì ID (ê³µë™ ì‘ì—…ì í™•ì¸ìš©): <span id="user-id" class="font-mono text-blue-600 bg-blue-100 p-1 rounded-md text-xs">ë¡œë”© ì¤‘...</span>
      </p>
      <p>ì¸ì¦ ìƒíƒœ: <span id="auth-status" class="text-red-500 font-semibold">ì´ˆê¸°í™” ì¤‘...</span></p>
      <div id="error-message" class="hidden text-center py-2 text-red-600 font-semibold mt-2 border-t border-red-300"></div>
    </div>

    <div id="loading-message" class="text-center py-12 text-lg text-gray-500">
      ì‹¤ì‹œê°„ ì‹œê°„í‘œ ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
    </div>

    <div id="schedule-container"
      class="schedule-grid grid border border-gray-200 rounded-lg overflow-x-auto">
      <!-- JSì—ì„œ ë Œë”ë§ -->
    </div>

    <footer class="mt-8 pt-4 border-t text-sm text-gray-500 text-center">
      <p>ëª¨ë“  ë³€ê²½ ì‚¬í•­ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥ ë° ê³µìœ ë©ë‹ˆë‹¤. êµê³¼ëª© ì…ë ¥ í›„ ì—”í„°(Enter)ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ë‹¤ë¥¸ ì¹¸ì„ ì„ íƒí•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤.</p>
    </footer>
  </div>
</body>
</html>
